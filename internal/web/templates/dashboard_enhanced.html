<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - Enhanced Dashboard</title>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <!-- D3.js for advanced visualizations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .status-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background-color: #28a745;
        }

        .status-offline {
            background-color: #dc3545;
        }

        .status-degraded {
            background-color: #ffc107;
        }

        .main-content {
            padding: 30px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border: 1px solid #e9ecef;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1em;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .chart-title {
            font-size: 1.4em;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        .chart-canvas {
            width: 100% !important;
            height: 300px !important;
        }

        .chart-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .chart-control-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
        }

        .chart-control-btn:hover {
            background: #2980b9;
        }

        .chart-control-btn.active {
            background: #2c3e50;
        }

        .topology-container {
            grid-column: span 2;
            min-height: 400px;
        }

        .timeline-container {
            grid-column: span 2;
        }

        .clients-section {
            margin-top: 30px;
        }

        .section-title {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .clients-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .clients-table th,
        .clients-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .clients-table th {
            background: #2c3e50;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
        }

        .clients-table tr:hover {
            background: #f8f9fa;
        }

        .client-status {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .client-online {
            background: #d4edda;
            color: #155724;
        }

        .client-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .refresh-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }

        .refresh-button:hover {
            background: #2980b9;
        }

        .footer {
            background: #2c3e50;
            color: white;
            padding: 20px 30px;
            text-align: center;
            font-size: 0.9em;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chart-error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #dc3545;
            font-size: 1.1em;
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .topology-container,
            .timeline-container {
                grid-column: span 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 5px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .main-content {
                padding: 20px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .chart-controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç {{.Title}}</h1>
            <p>Enhanced Network Analysis Dashboard</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-icon {{if .ConnectionStatus.Connected}}status-online{{else}}status-offline{{end}}"></div>
                <span>Pi-hole Connection: {{if .ConnectionStatus.Connected}}Connected{{else}}Disconnected{{end}}</span>
            </div>
            <div class="status-item">
                <span>Last Update: {{.ConnectionStatus.LastConnect}}</span>
            </div>
            <div class="status-item">
                <button class="refresh-button" onclick="refreshAllCharts()">üîÑ Refresh</button>
            </div>
        </div>

        <div class="main-content">
            {{if .AnalysisResult}}
            <!-- Summary Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-queries">{{.AnalysisResult.TotalQueries}}</div>
                    <div class="stat-label">Total Queries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="unique-clients">{{.AnalysisResult.UniqueClients}}</div>
                    <div class="stat-label">Unique Clients</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-clients">{{len .AnalysisResult.ClientStats}}</div>
                    <div class="stat-label">Active Clients</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="network-devices">{{len .AnalysisResult.NetworkDevices}}</div>
                    <div class="stat-label">Network Devices</div>
                </div>
            </div>

            <!-- Interactive Charts Dashboard -->
            <div class="dashboard-grid">
                <!-- Query Timeline Chart -->
                <div class="chart-container timeline-container">
                    <div class="chart-title">üìà Query Activity Timeline</div>
                    <div class="chart-controls">
                        <button class="chart-control-btn active" onclick="updateTimelineChart('1h')">1 Hour</button>
                        <button class="chart-control-btn" onclick="updateTimelineChart('6h')">6 Hours</button>
                        <button class="chart-control-btn" onclick="updateTimelineChart('24h')">24 Hours</button>
                        <button class="chart-control-btn" onclick="updateTimelineChart('7d')">7 Days</button>
                    </div>
                    <canvas id="timeline-chart" class="chart-canvas"></canvas>
                    <div id="timeline-loading" class="loading-overlay" style="display: none;">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Client Distribution Chart -->
                <div class="chart-container">
                    <div class="chart-title">üë• Client Activity Distribution</div>
                    <div class="chart-controls">
                        <button class="chart-control-btn active" onclick="updateClientChart('pie')">Pie Chart</button>
                        <button class="chart-control-btn" onclick="updateClientChart('doughnut')">Doughnut</button>
                    </div>
                    <canvas id="client-chart" class="chart-canvas"></canvas>
                    <div id="client-loading" class="loading-overlay" style="display: none;">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Domain Statistics Chart -->
                <div class="chart-container">
                    <div class="chart-title">üåê Top Domains</div>
                    <div class="chart-controls">
                        <button class="chart-control-btn active" onclick="updateDomainChart(20)">Top 20</button>
                        <button class="chart-control-btn" onclick="updateDomainChart(10)">Top 10</button>
                        <button class="chart-control-btn" onclick="updateDomainChart(50)">Top 50</button>
                    </div>
                    <canvas id="domain-chart" class="chart-canvas"></canvas>
                    <div id="domain-loading" class="loading-overlay" style="display: none;">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="chart-container">
                    <div class="chart-title">‚ö° Performance Metrics</div>
                    <canvas id="performance-chart" class="chart-canvas"></canvas>
                    <div id="performance-loading" class="loading-overlay" style="display: none;">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Network Topology Visualization -->
                <div class="chart-container topology-container">
                    <div class="chart-title">üåê Network Topology</div>
                    <div class="chart-controls">
                        <button class="chart-control-btn active" onclick="updateTopologyChart(25)">25 Nodes</button>
                        <button class="chart-control-btn" onclick="updateTopologyChart(50)">50 Nodes</button>
                        <button class="chart-control-btn" onclick="updateTopologyChart(100)">100 Nodes</button>
                    </div>
                    <div id="topology-chart" style="width: 100%; height: 350px;"></div>
                    <div id="topology-loading" class="loading-overlay" style="display: none;">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Client Statistics Table -->
            <div class="clients-section">
                <h2 class="section-title">üìä Client Statistics</h2>
                {{if .AnalysisResult.ClientStats}}
                <table class="clients-table">
                    <thead>
                        <tr>
                            <th>IP Address</th>
                            <th>Hostname</th>
                            <th>Status</th>
                            <th>Queries</th>
                            <th>Unique Domains</th>
                            <th>MAC Address</th>
                        </tr>
                    </thead>
                    <tbody id="clients-table-body">
                        {{range .AnalysisResult.ClientStats}}
                        <tr>
                            <td>{{.IP}}</td>
                            <td>{{if .Hostname}}{{.Hostname}}{{else}}Unknown{{end}}</td>
                            <td>
                                <span class="client-status {{if .IsOnline}}client-online{{else}}client-offline{{end}}">
                                    {{if .IsOnline}}‚úÖ Online{{else}}‚ùå Offline{{end}}
                                </span>
                            </td>
                            <td>{{.QueryCount}}</td>
                            <td>{{.DomainCount}}</td>
                            <td>{{if .MACAddress}}{{.MACAddress}}{{else}}N/A{{end}}</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
                {{else}}
                <div class="loading">No client data available</div>
                {{end}}
            </div>
            {{else}}
            <div class="error">
                Failed to load analysis data. Please check your Pi-hole connection.
            </div>
            {{end}}
        </div>

        <div class="footer">
            <p>Pi-hole Network Analyzer v{{.ServerInfo.Version}} | Build: {{.ServerInfo.BuildTime}}</p>
            <p>üåê Enhanced Dashboard | üì° Real-time Analysis | üìà Interactive Charts</p>
        </div>
    </div>

    <script>
        // Global chart instances
        let timelineChart = null;
        let clientChart = null;
        let domainChart = null;
        let performanceChart = null;
        let topologySimulation = null;

        // WebSocket connection for real-time updates
        let ws;
        let reconnectInterval = 1000;
        let maxReconnectInterval = 30000;
        let reconnectAttempts = 0;
        let connectionStatus = false;

        // Chart color schemes
        const colors = {
            primary: '#3498db',
            success: '#27ae60',
            danger: '#e74c3c',
            warning: '#f39c12',
            info: '#17a2b8',
            light: '#f8f9fa',
            dark: '#2c3e50'
        };

        const chartColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
            '#FF9F40', '#C9CBCF', '#4BC0C0', '#FF6384', '#36A2EB'
        ];

        // Initialize dashboard on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Enhanced Pi-hole Dashboard loaded');
            
            // Initialize all charts
            initializeCharts();
            
            // Initialize WebSocket connection
            initWebSocket();
            
            // Start periodic updates
            setInterval(updateCharts, 30000); // Update every 30 seconds
        });

        // Initialize all charts
        function initializeCharts() {
            console.log('Initializing charts...');
            
            // Initialize timeline chart
            initTimelineChart();
            
            // Initialize client chart
            initClientChart();
            
            // Initialize domain chart
            initDomainChart();
            
            // Initialize performance chart
            initPerformanceChart();
            
            // Initialize network topology
            initTopologyChart();
        }

        // Initialize timeline chart
        function initTimelineChart() {
            const ctx = document.getElementById('timeline-chart').getContext('2d');
            
            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Query Count'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Load initial data
            updateTimelineChart('24h');
        }

        // Initialize client chart
        function initClientChart() {
            const ctx = document.getElementById('client-chart').getContext('2d');
            
            clientChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            enabled: true
                        }
                    }
                }
            });
            
            // Load initial data
            updateClientChart('pie');
        }

        // Initialize domain chart
        function initDomainChart() {
            const ctx = document.getElementById('domain-chart').getContext('2d');
            
            domainChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Load initial data
            updateDomainChart(20);
        }

        // Initialize performance chart
        function initPerformanceChart() {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            
            performanceChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Load initial data
            updatePerformanceChart();
        }

        // Initialize network topology chart
        function initTopologyChart() {
            updateTopologyChart(25);
        }

        // Update timeline chart
        function updateTimelineChart(timeWindow) {
            showLoading('timeline-loading');
            
            // Update active button
            document.querySelectorAll('.timeline-container .chart-control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            fetch(`/api/charts/timeline?window=${timeWindow}&granularity=1h`)
                .then(response => response.json())
                .then(data => {
                    timelineChart.data.labels = data.labels;
                    timelineChart.data.datasets = data.datasets;
                    timelineChart.update();
                    hideLoading('timeline-loading');
                })
                .catch(error => {
                    console.error('Error updating timeline chart:', error);
                    showChartError('timeline-chart', 'Failed to load timeline data');
                    hideLoading('timeline-loading');
                });
        }

        // Update client chart
        function updateClientChart(chartType) {
            showLoading('client-loading');
            
            // Update active button
            document.querySelectorAll('.chart-container:nth-child(2) .chart-control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update chart type
            clientChart.config.type = chartType;
            
            fetch(`/api/charts/clients?type=${chartType}`)
                .then(response => response.json())
                .then(data => {
                    clientChart.data.labels = data.labels;
                    clientChart.data.datasets = data.datasets;
                    clientChart.update();
                    hideLoading('client-loading');
                })
                .catch(error => {
                    console.error('Error updating client chart:', error);
                    showChartError('client-chart', 'Failed to load client data');
                    hideLoading('client-loading');
                });
        }

        // Update domain chart
        function updateDomainChart(limit) {
            showLoading('domain-loading');
            
            // Update active button
            document.querySelectorAll('.chart-container:nth-child(3) .chart-control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            fetch(`/api/charts/domains?limit=${limit}`)
                .then(response => response.json())
                .then(data => {
                    domainChart.data.labels = data.labels;
                    domainChart.data.datasets = data.datasets;
                    domainChart.update();
                    hideLoading('domain-loading');
                })
                .catch(error => {
                    console.error('Error updating domain chart:', error);
                    showChartError('domain-chart', 'Failed to load domain data');
                    hideLoading('domain-loading');
                });
        }

        // Update performance chart
        function updatePerformanceChart() {
            showLoading('performance-loading');
            
            fetch('/api/charts/performance')
                .then(response => response.json())
                .then(data => {
                    performanceChart.data.labels = data.labels;
                    performanceChart.data.datasets = data.datasets;
                    performanceChart.update();
                    hideLoading('performance-loading');
                })
                .catch(error => {
                    console.error('Error updating performance chart:', error);
                    showChartError('performance-chart', 'Failed to load performance data');
                    hideLoading('performance-loading');
                });
        }

        // Update network topology chart
        function updateTopologyChart(maxNodes) {
            showLoading('topology-loading');
            
            // Update active button
            document.querySelectorAll('.topology-container .chart-control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            fetch(`/api/charts/topology?max_nodes=${maxNodes}`)
                .then(response => response.json())
                .then(data => {
                    renderNetworkTopology(data);
                    hideLoading('topology-loading');
                })
                .catch(error => {
                    console.error('Error updating topology chart:', error);
                    showTopologyError('Failed to load network topology');
                    hideLoading('topology-loading');
                });
        }

        // Render network topology using D3.js
        function renderNetworkTopology(data) {
            const container = document.getElementById('topology-chart');
            
            // Clear previous visualization
            d3.select(container).selectAll("*").remove();
            
            const width = container.clientWidth;
            const height = 350;
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);
                
            const simulation = d3.forceSimulation(data.nodes)
                .force('link', d3.forceLink(data.links).id(d => d.id).distance(80))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2));
                
            // Create links
            const link = svg.append('g')
                .selectAll('line')
                .data(data.links)
                .enter().append('line')
                .attr('stroke', '#999')
                .attr('stroke-opacity', 0.6)
                .attr('stroke-width', d => Math.sqrt(d.weight / 100));
                
            // Create nodes
            const node = svg.append('g')
                .selectAll('circle')
                .data(data.nodes)
                .enter().append('circle')
                .attr('r', d => d.size)
                .attr('fill', d => d.color)
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));
                    
            // Add labels
            const label = svg.append('g')
                .selectAll('text')
                .data(data.nodes)
                .enter().append('text')
                .text(d => d.label)
                .attr('font-size', '10px')
                .attr('dx', 15)
                .attr('dy', 4);
                
            // Add tooltips
            node.append('title')
                .text(d => `${d.label}\nType: ${d.type}\nQueries: ${d.metadata.queries || 'N/A'}`);
                
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                    
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                    
                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
            
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
            
            topologySimulation = simulation;
        }

        // Refresh all charts
        function refreshAllCharts() {
            console.log('Refreshing all charts...');
            updateTimelineChart('24h');
            updateClientChart('pie');
            updateDomainChart(20);
            updatePerformanceChart();
            updateTopologyChart(25);
        }

        // Update specific charts based on real-time data
        function updateCharts() {
            if (!connectionStatus) return;
            
            // Update charts without changing user selections
            const activeTimeWindow = document.querySelector('.timeline-container .chart-control-btn.active').textContent.toLowerCase().replace(' ', '');
            const activeClientType = document.querySelector('.chart-container:nth-child(2) .chart-control-btn.active').textContent.toLowerCase().split(' ')[0];
            const activeDomainLimit = parseInt(document.querySelector('.chart-container:nth-child(3) .chart-control-btn.active').textContent.match(/\d+/)[0]);
            const activeTopologyNodes = parseInt(document.querySelector('.topology-container .chart-control-btn.active').textContent.match(/\d+/)[0]);
            
            fetch(`/api/charts/timeline?window=${activeTimeWindow}&granularity=1h`)
                .then(response => response.json())
                .then(data => {
                    timelineChart.data.labels = data.labels;
                    timelineChart.data.datasets = data.datasets;
                    timelineChart.update('none');
                })
                .catch(error => console.error('Error updating timeline:', error));
                
            // Update other charts similarly...
        }

        // WebSocket functions (reused from original dashboard)
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            console.log('Connecting to WebSocket:', wsUrl);
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                console.log('WebSocket connected');
                connectionStatus = true;
                reconnectAttempts = 0;
                reconnectInterval = 1000;
                updateConnectionIndicator(true);
                
                ws.send(JSON.stringify({
                    type: 'subscribe',
                    channel: 'dashboard'
                }));
            };
            
            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };
            
            ws.onclose = function(event) {
                console.log('WebSocket disconnected');
                connectionStatus = false;
                updateConnectionIndicator(false);
                
                setTimeout(function() {
                    reconnectAttempts++;
                    reconnectInterval = Math.min(reconnectInterval * 1.5, maxReconnectInterval);
                    console.log(`Reconnecting... Attempt ${reconnectAttempts}`);
                    initWebSocket();
                }, reconnectInterval);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        function handleWebSocketMessage(message) {
            console.log('Received WebSocket message:', message.type);
            
            switch (message.type) {
                case 'dashboard_update':
                case 'chart_update':
                    updateChartsFromWebSocket(message.data);
                    break;
                case 'client_update':
                    updateClientTableFromWebSocket(message.data);
                    break;
                case 'metrics_update':
                    updateMetricsFromWebSocket(message.data);
                    break;
            }
        }

        function updateChartsFromWebSocket(data) {
            // Update charts with real-time data
            if (data.timeline) {
                updateTimelineFromWebSocket(data.timeline);
            }
            if (data.clients) {
                updateClientChartFromWebSocket(data.clients);
            }
            // Add more real-time updates as needed
        }

        // Utility functions
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'flex';
            }
        }

        function hideLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'none';
            }
        }

        function showChartError(chartId, message) {
            const canvas = document.getElementById(chartId);
            const container = canvas.parentElement;
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'chart-error';
            errorDiv.textContent = message;
            
            canvas.style.display = 'none';
            container.appendChild(errorDiv);
        }

        function showTopologyError(message) {
            const container = document.getElementById('topology-chart');
            container.innerHTML = `<div class="chart-error">${message}</div>`;
        }

        function updateConnectionIndicator(connected) {
            const statusBar = document.querySelector('.status-bar');
            let wsIndicator = document.querySelector('.ws-status');
            
            if (!wsIndicator) {
                wsIndicator = document.createElement('div');
                wsIndicator.className = 'status-item ws-status';
                statusBar.appendChild(wsIndicator);
            }
            
            wsIndicator.innerHTML = `
                <div class="status-icon ${connected ? 'status-online' : 'status-offline'}"></div>
                <span>Real-time: ${connected ? 'Connected' : 'Connecting...'}</span>
            `;
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('Page hidden, maintaining connections');
            } else {
                console.log('Page visible, refreshing charts');
                if (connectionStatus) {
                    updateCharts();
                }
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>
